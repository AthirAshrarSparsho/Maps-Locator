<!doctype html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Public Charging Outlet Finder</title>
  <meta name="description" content="Find top-ranked public places to charge phones, tablets, and laptops." />
  <meta name="theme-color" content="#0b1220" />
  <link rel="icon" href="data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 64 64'%3E%3Cdefs%3E%3ClinearGradient id='g' x1='0' y1='0' x2='1' y2='1'%3E%3Cstop offset='0%25' stop-color='%2322d3ee'/%3E%3Cstop offset='100%25' stop-color='%234f46e5'/%3E%3C/linearGradient%3E%3C/defs%3E%3Crect x='4' y='4' width='56' height='56' rx='16' fill='url(%23g)'/%3E%3Cpath d='M36 10L18 35h12l-2 19 18-25H34z' fill='%23061116'/%3E%3C/svg%3E" />

  <link rel="preconnect" href="https://unpkg.com" />
  <link rel="preconnect" href="https://overpass-api.de" />
  <link rel="preconnect" href="https://nominatim.openstreetmap.org" />
  <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" crossorigin="" />

  <style>
    :root {
      --bg: #070b14;
      --bg2: #080f1d;
      --panel: rgba(10, 16, 32, 0.86);
      --card: rgba(15, 23, 42, 0.78);
      --line: rgba(148, 163, 184, 0.22);
      --line-strong: rgba(148, 163, 184, 0.4);
      --text: #e2e8f0;
      --muted: #93a4bf;
      --accent: #5eead4;
      --primary: #4f46e5;
      --ok: #22c55e;
      --warn: #f59e0b;
      --bad: #ef4444;
      --chip: #1a2440;
      --radius: 16px;
      --shadow: 0 10px 30px rgba(2, 6, 23, 0.45);
      --shadow-soft: 0 4px 16px rgba(2, 6, 23, 0.35);
      --gradient:
        radial-gradient(1200px 500px at 0% -20%, rgba(34, 211, 238, 0.22), transparent 50%),
        radial-gradient(900px 460px at 100% 0%, rgba(79, 70, 229, 0.24), transparent 48%),
        linear-gradient(180deg, var(--bg) 0%, var(--bg2) 100%);
    }

    body.theme-light {
      --bg: #f1f5f9;
      --bg2: #e2e8f0;
      --panel: rgba(255, 255, 255, 0.86);
      --card: rgba(255, 255, 255, 0.9);
      --line: rgba(71, 85, 105, 0.2);
      --line-strong: rgba(71, 85, 105, 0.35);
      --text: #0f172a;
      --muted: #475569;
      --accent: #0ea5e9;
      --primary: #4f46e5;
      --chip: #eef2ff;
      --shadow: 0 10px 30px rgba(15, 23, 42, 0.12);
      --shadow-soft: 0 4px 14px rgba(15, 23, 42, 0.08);
      --gradient:
        radial-gradient(1100px 480px at 0% -20%, rgba(14, 165, 233, 0.18), transparent 50%),
        radial-gradient(900px 420px at 100% 0%, rgba(99, 102, 241, 0.16), transparent 52%),
        linear-gradient(180deg, var(--bg) 0%, var(--bg2) 100%);
    }

    * { box-sizing: border-box; }
    html, body { height: 100%; }

    body {
      margin: 0;
      font-family: Inter, ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto, Helvetica, Arial, sans-serif;
      color: var(--text);
      background: var(--gradient);
      overflow: hidden;
      transition: background 0.25s ease;
    }

    .app {
      display: grid;
      grid-template-columns: var(--sidebar-width, 430px) 1fr;
      height: 100vh;
      transition: grid-template-columns 0.22s ease;
    }

    .app.sidebar-collapsed { --sidebar-width: 74px; }

    .sidebar {
      border-right: 1px solid var(--line);
      background: var(--panel);
      backdrop-filter: blur(12px);
      -webkit-backdrop-filter: blur(12px);
      overflow: auto;
      padding: 12px;
      position: relative;
    }

    .brand-wrap {
      display: flex;
      align-items: center;
      justify-content: space-between;
      gap: 8px;
      margin-bottom: 10px;
    }

    .brand {
      display: flex;
      gap: 10px;
      align-items: center;
      min-width: 0;
    }

    .logo {
      width: 34px;
      height: 34px;
      border-radius: 11px;
      background: linear-gradient(145deg, var(--accent), var(--primary));
      box-shadow: 0 6px 16px rgba(34, 211, 238, 0.35);
      display: grid;
      place-items: center;
      color: #05111b;
      font-weight: 900;
      font-size: 14px;
      flex-shrink: 0;
    }

    h1 {
      margin: 0;
      font-size: 1.02rem;
      letter-spacing: 0.3px;
      white-space: nowrap;
      overflow: hidden;
      text-overflow: ellipsis;
    }

    .subtitle {
      color: var(--muted);
      font-size: 0.82rem;
      margin-top: 2px;
      line-height: 1.28;
    }

    .icon-btn {
      cursor: pointer;
      border: 1px solid var(--line-strong);
      background: rgba(15, 23, 42, 0.45);
      color: var(--text);
      width: 34px;
      height: 34px;
      border-radius: 10px;
      display: grid;
      place-items: center;
      font-size: 0.95rem;
      transition: filter 0.15s ease, background 0.2s ease;
      flex-shrink: 0;
    }

    body.theme-light .icon-btn { background: rgba(255,255,255,0.85); }
    .icon-btn:hover { filter: brightness(1.08); }

    .panel {
      background: linear-gradient(180deg, rgba(15, 23, 42, 0.74), rgba(10, 16, 28, 0.72));
      border: 1px solid var(--line);
      border-radius: var(--radius);
      padding: 12px;
      margin-bottom: 10px;
      box-shadow: var(--shadow-soft);
    }

    body.theme-light .panel {
      background: linear-gradient(180deg, rgba(255,255,255,0.95), rgba(255,255,255,0.86));
    }

    .panel-title {
      font-size: 0.82rem;
      font-weight: 800;
      letter-spacing: 0.2px;
      margin-bottom: 9px;
      display: flex;
      align-items: center;
      justify-content: space-between;
      gap: 8px;
    }

    .row {
      display: flex;
      gap: 8px;
      align-items: center;
      flex-wrap: wrap;
      margin-bottom: 8px;
    }
    .row:last-child { margin-bottom: 0; }

    label {
      font-size: 0.78rem;
      letter-spacing: 0.2px;
      color: color-mix(in srgb, var(--text) 82%, var(--muted) 18%);
    }

    .control {
      background: rgba(9, 14, 26, 0.92);
      color: var(--text);
      border: 1px solid var(--line-strong);
      border-radius: 10px;
      padding: 8px 9px;
      font-size: 0.86rem;
      outline: none;
      transition: border-color .16s ease, box-shadow .16s ease, background .16s ease;
    }

    body.theme-light .control { background: rgba(255,255,255,0.95); }

    .control:focus {
      border-color: color-mix(in srgb, var(--accent) 78%, white 22%);
      box-shadow: 0 0 0 3px color-mix(in srgb, var(--accent) 24%, transparent 76%);
    }

    input[type="number"].control { width: 92px; }
    select.control { min-width: 126px; }
    input[type="text"].control { flex: 1; min-width: 220px; }

    .btn {
      cursor: pointer;
      border: 1px solid transparent;
      border-radius: 11px;
      padding: 9px 11px;
      font-weight: 800;
      font-size: 0.79rem;
      transition: transform .08s ease, filter .16s ease, border-color .16s ease, background .16s ease;
      white-space: nowrap;
    }
    .btn:hover { filter: brightness(1.08); }
    .btn:active { transform: translateY(1px); }
    .btn:disabled { opacity: 0.55; cursor: not-allowed; }

    .btn-primary {
      background: linear-gradient(135deg, #10b981, #14b8a6);
      color: #062018;
      border-color: rgba(20, 184, 166, 0.45);
    }

    .btn-secondary {
      background: linear-gradient(135deg, #334155, #3f4f68);
      border-color: rgba(148, 163, 184, 0.34);
      color: #e5edf9;
    }

    body.theme-light .btn-secondary {
      background: linear-gradient(135deg, #dbeafe, #c7d2fe);
      color: #1e293b;
      border-color: rgba(71, 85, 105, 0.28);
    }

    .btn-ghost {
      background: rgba(30, 41, 59, 0.85);
      border-color: rgba(100, 116, 139, 0.35);
      color: #d3ddeb;
    }

    body.theme-light .btn-ghost {
      background: rgba(241,245,249,0.95);
      color: #1e293b;
    }

    .btn-danger {
      background: linear-gradient(135deg, #7f1d1d, #b91c1c);
      border-color: rgba(239, 68, 68, 0.35);
      color: #fee2e2;
    }

    .toggle-grid {
      display: grid;
      grid-template-columns: 1fr 1fr;
      gap: 8px;
    }

    .toggle {
      display: flex;
      gap: 8px;
      align-items: center;
      font-size: 0.79rem;
      background: rgba(15, 23, 42, 0.55);
      border: 1px solid var(--line);
      border-radius: 10px;
      padding: 7px 9px;
    }
    body.theme-light .toggle { background: rgba(248, 250, 252, 0.95); }

    .chips {
      display: flex;
      gap: 7px;
      flex-wrap: wrap;
      margin-top: 2px;
    }

    .chip {
      border: 1px solid rgba(148, 163, 184, 0.28);
      background: var(--chip);
      border-radius: 999px;
      padding: 6px 10px;
      font-size: 0.77rem;
      cursor: pointer;
      user-select: none;
      transition: all .15s ease;
      color: color-mix(in srgb, var(--text) 88%, #c5d5ff 12%);
    }

    .chip:hover { border-color: rgba(148, 163, 184, 0.56); }
    .chip.active {
      background: linear-gradient(135deg, #1d4ed8, #4f46e5);
      border-color: rgba(99, 102, 241, 0.95);
      color: #eff6ff;
    }

    .kpis {
      display: grid;
      grid-template-columns: repeat(3, minmax(0,1fr));
      gap: 8px;
      margin-top: 5px;
    }

    .kpi {
      border: 1px solid var(--line);
      border-radius: 12px;
      padding: 8px 9px;
      background: rgba(9, 14, 26, 0.7);
    }
    body.theme-light .kpi { background: rgba(255,255,255,0.95); }

    .kpi .v { font-size: 0.96rem; font-weight: 900; line-height: 1.1; }
    .kpi .l { font-size: 0.72rem; color: var(--muted); margin-top: 2px; }

    .status {
      border: 1px solid var(--line);
      background: rgba(8, 13, 24, 0.7);
      border-radius: 12px;
      padding: 9px 10px;
      font-size: 0.81rem;
      color: var(--muted);
      min-height: 38px;
      display: flex;
      align-items: center;
      margin-top: 8px;
    }
    body.theme-light .status { background: rgba(255,255,255,0.95); }

    .list-head {
      display: flex;
      align-items: center;
      justify-content: space-between;
      margin: 6px 2px;
      font-size: 0.82rem;
      gap: 8px;
    }

    .tiny { font-size: 0.75rem; color: var(--muted); }

    .results {
      display: flex;
      flex-direction: column;
      gap: 8px;
      margin-top: 8px;
      max-height: 37vh;
      overflow: auto;
      padding-right: 2px;
    }

    .results.favs { max-height: 22vh; }

    .card {
      background: linear-gradient(180deg, rgba(15, 23, 42, 0.82), rgba(11, 18, 32, 0.76));
      border: 1px solid var(--line);
      border-radius: 14px;
      padding: 10px;
      box-shadow: var(--shadow-soft);
      transition: border-color .14s ease, transform .08s ease;
    }
    body.theme-light .card {
      background: linear-gradient(180deg, rgba(255,255,255,0.96), rgba(248,250,252,0.94));
    }
    .card:hover { border-color: rgba(148, 163, 184, 0.52); }

    .title-row { display: flex; justify-content: space-between; gap: 8px; align-items: start; }
    .title { font-size: 0.92rem; font-weight: 900; line-height: 1.24; }

    .confidence {
      font-size: 0.7rem;
      border-radius: 999px;
      padding: 3px 8px;
      border: 1px solid transparent;
      white-space: nowrap;
    }
    .conf-high { background: rgba(34, 197, 94, 0.13); border-color: rgba(34, 197, 94, 0.4); color: #bbf7d0; }
    .conf-mid  { background: rgba(245, 158, 11, 0.12); border-color: rgba(245, 158, 11, 0.4); color: #fde68a; }
    .conf-low  { background: rgba(239, 68, 68, 0.11); border-color: rgba(239, 68, 68, 0.35); color: #fecaca; }

    .meta { font-size: 0.77rem; color: var(--muted); line-height: 1.35; margin: 4px 0 6px; }

    .pill {
      display: inline-block;
      border: 1px solid rgba(148, 163, 184, 0.35);
      border-radius: 999px;
      padding: 2px 7px;
      font-size: 0.7rem;
      margin-right: 5px;
      margin-bottom: 5px;
      text-decoration: none;
      background: rgba(15, 23, 42, 0.55);
      color: color-mix(in srgb, var(--text) 82%, #a8b9ce 18%);
    }
    body.theme-light .pill { background: rgba(248,250,252,0.95); }

    .actions { display: flex; gap: 6px; flex-wrap: wrap; margin-top: 6px; }

    .pill-btn {
      cursor: pointer;
      border: 1px solid rgba(148, 163, 184, 0.34);
      border-radius: 999px;
      padding: 4px 8px;
      font-size: 0.72rem;
      background: rgba(15, 23, 42, 0.58);
      color: color-mix(in srgb, var(--text) 86%, #b3c5e2 14%);
    }
    body.theme-light .pill-btn { background: rgba(248,250,252,0.95); }
    .pill-btn.ok { border-color: rgba(34, 197, 94, 0.5); color: #bbf7d0; }
    .pill-btn.bad { border-color: rgba(239, 68, 68, 0.5); color: #fecaca; }

    .footer-note {
      margin-top: 12px;
      padding: 9px 8px;
      border: 1px solid var(--line);
      background: rgba(8, 13, 24, 0.6);
      border-radius: 12px;
      text-align: center;
      color: var(--muted);
      font-size: 0.76rem;
      letter-spacing: 0.2px;
    }
    body.theme-light .footer-note { background: rgba(255,255,255,0.95); }

    .map-wrap { position: relative; height: 100vh; min-width: 0; }
    #map { height: 100%; width: 100%; }

    .overlay {
      position: absolute;
      z-index: 1000;
      backdrop-filter: blur(8px);
      -webkit-backdrop-filter: blur(8px);
      border: 1px solid var(--line);
      background: rgba(9, 14, 26, 0.78);
      border-radius: 12px;
      color: color-mix(in srgb, var(--text) 84%, #b9cbe2 16%);
    }
    body.theme-light .overlay {
      background: rgba(255,255,255,0.9);
      color: #334155;
    }

    .top-right {
      top: 12px;
      right: 12px;
      max-width: 470px;
      padding: 8px 10px;
      font-size: 0.77rem;
      line-height: 1.35;
    }

    .bottom-right {
      bottom: 12px;
      right: 12px;
      padding: 9px 10px;
      font-size: 0.76rem;
      display: flex;
      gap: 8px;
      align-items: center;
      flex-wrap: wrap;
      max-width: 520px;
    }

    .legend-dot {
      width: 10px;
      height: 10px;
      border-radius: 999px;
      display: inline-block;
      margin-right: 5px;
      transform: translateY(1px);
    }
    .dot-high { background: #22c55e; }
    .dot-mid { background: #f59e0b; }
    .dot-low { background: #ef4444; }

    .map-style { min-width: 150px; }

    .leaflet-popup-content-wrapper,
    .leaflet-popup-tip {
      background: #0b1220;
      color: #dbe7fb;
      border: 1px solid rgba(148, 163, 184, 0.28);
    }
    body.theme-light .leaflet-popup-content-wrapper,
    body.theme-light .leaflet-popup-tip {
      background: #ffffff;
      color: #0f172a;
      border-color: rgba(71, 85, 105, 0.25);
    }

    .app.sidebar-collapsed { grid-template-columns: 74px 1fr; }
    .app.sidebar-collapsed .panel,
    .app.sidebar-collapsed .footer-note,
    .app.sidebar-collapsed .hide-on-collapse { display: none; }
    .app.sidebar-collapsed .brand-wrap { justify-content: center; }
    .app.sidebar-collapsed .brand { gap: 0; }
    .app.sidebar-collapsed .sidebar { padding: 10px 8px; overflow-x: hidden; }

    @media (max-width: 980px) {
      body { overflow: auto; }
      .app {
        grid-template-columns: 1fr;
        grid-template-rows: 56vh auto;
        height: auto;
        min-height: 100vh;
      }
      .sidebar {
        border-right: none;
        border-bottom: 1px solid var(--line);
      }
      .map-wrap { height: 44vh; }
      .results { max-height: 40vh; }
      .results.favs { max-height: 25vh; }

      .app.sidebar-collapsed { grid-template-columns: 1fr; }
      .app.sidebar-collapsed .panel,
      .app.sidebar-collapsed .footer-note,
      .app.sidebar-collapsed .hide-on-collapse { display: block; }
    }

    /* ===== Autocomplete dropdown ===== */
    .autocomplete-wrap {
      position: relative;
      flex: 1;
      min-width: 220px;
    }

    .suggestions {
      position: absolute;
      top: calc(100% + 6px);
      left: 0;
      right: 0;
      z-index: 1200;
      border: 1px solid var(--line-strong);
      border-radius: 12px;
      background: rgba(9, 14, 26, 0.98);
      box-shadow: var(--shadow-soft);
      max-height: 260px;
      overflow: auto;
      display: none;
    }

    body.theme-light .suggestions {
      background: rgba(255,255,255,0.98);
    }

    .suggestion-item {
      padding: 9px 10px;
      border-bottom: 1px solid var(--line);
      cursor: pointer;
      font-size: 0.83rem;
      line-height: 1.3;
      color: var(--text);
    }

    .suggestion-item:last-child { border-bottom: none; }
    .suggestion-item:hover,
    .suggestion-item.active {
      background: color-mix(in srgb, var(--primary) 18%, transparent 82%);
    }

    .suggestion-main {
      font-weight: 700;
      font-size: 0.83rem;
      margin-bottom: 2px;
    }

    .suggestion-sub {
      color: var(--muted);
      font-size: 0.75rem;
    }
  </style>
</head>

<body>
  <div id="app" class="app">
    <aside class="sidebar">
      <div class="brand-wrap">
        <div class="brand">
          <div class="logo" title="Public Charging Outlet Finder">‚ö°</div>
          <div class="hide-on-collapse">
            <h1>Public Charging Outlet Finder</h1>
            <div class="subtitle">Find likely charging outlets around you</div>
          </div>
        </div>
        <div class="row" style="margin:0; gap:6px;">
          <button id="themeBtn" class="icon-btn" title="Toggle light/dark theme">üåì</button>
          <button id="collapseBtn" class="icon-btn" title="Collapse sidebar">‚ò∞</button>
        </div>
      </div>

      <div class="panel">
        <div class="panel-title">
          <span>Search</span>
          <span class="tiny">Settings auto-save</span>
        </div>

        <div class="row">
          <label for="radiusKm">Radius (km)</label>
          <input id="radiusKm" class="control" type="number" min="1" max="30" step="1" value="5"/>

          <label for="sortBy">Sort</label>
          <select id="sortBy" class="control">
            <option value="best">Best Match</option>
            <option value="nearest">Nearest</option>
            <option value="community">Community Score</option>
            <option value="confidence">Confidence</option>
          </select>
        </div>

        <div class="row">
          <label for="addressInput">Address</label>
          <div class="autocomplete-wrap">
            <input id="addressInput" class="control" type="text" placeholder="e.g., 200 King St W, Toronto" autocomplete="off" />
            <div id="suggestions" class="suggestions" role="listbox" aria-label="Address suggestions"></div>
          </div>
          <button id="useAddressBtn" class="btn btn-secondary">Use Address</button>
        </div>

        <div class="row">
          <button id="locateBtn" class="btn btn-primary">Use My Location</button>
          <button id="refreshBtn" class="btn btn-secondary">Refresh</button>
          <button id="offlineBtn" class="btn btn-ghost">Load Cache</button>
        </div>

        <div class="toggle-grid">
          <label class="toggle"><input id="open247Only" type="checkbox" /> 24/7 only</label>
          <label class="toggle"><input id="showHeat" type="checkbox" checked /> Heat bubbles</label>
          <label class="toggle"><input id="wifiOnly" type="checkbox" /> Wi-Fi likely</label>
          <label class="toggle"><input id="highConfidenceOnly" type="checkbox" /> High confidence</label>
        </div>

        <div class="kpis">
          <div class="kpi">
            <div id="kpiTotal" class="v">0</div>
            <div class="l">Matches</div>
          </div>
          <div class="kpi">
            <div id="kpiHigh" class="v">0</div>
            <div class="l">High confidence</div>
          </div>
          <div class="kpi">
            <div id="kpiAvgDist" class="v">0.00 km</div>
            <div class="l">Avg distance</div>
          </div>
        </div>

        <div id="status" class="status">Use location or enter an address to begin.</div>
      </div>

      <div class="panel">
        <div class="panel-title">
          <span>Categories</span>
          <div class="row" style="margin:0; gap:6px;">
            <button id="selectAllCatsBtn" class="btn btn-ghost" style="padding:6px 8px; font-size:0.72rem;">All</button>
            <button id="clearCatsBtn" class="btn btn-ghost" style="padding:6px 8px; font-size:0.72rem;">None</button>
          </div>
        </div>
        <div id="chips" class="chips"></div>
      </div>

      <div class="panel">
        <div class="panel-title">
          <span>Favorites</span>
          <div class="row" style="margin:0; gap:6px;">
            <button id="exportFavBtn" class="btn btn-ghost" style="padding:6px 8px; font-size:0.72rem;">Export</button>
            <button id="importFavBtn" class="btn btn-ghost" style="padding:6px 8px; font-size:0.72rem;">Import</button>
            <button id="clearFavBtn" class="btn btn-danger" style="padding:6px 8px; font-size:0.72rem;">Clear</button>
            <input id="importFavFile" type="file" accept="application/json" style="display:none;" />
          </div>
        </div>
        <div id="favList" class="results favs"></div>
      </div>

      <div class="panel">
        <div class="list-head">
          <span>Results</span>
          <span class="tiny" id="count">0 match(es)</span>
        </div>
        <div id="results" class="results"></div>
      </div>

      <div class="footer-note">¬© 2026 Athir Global Partners</div>
    </aside>

    <main class="map-wrap">
      <div class="overlay top-right">
        Data: OpenStreetMap via Overpass + Nominatim. Votes/favorites/settings are saved locally on your device.
      </div>

      <div class="overlay bottom-right">
        <span><span class="legend-dot dot-high"></span>High confidence</span>
        <span><span class="legend-dot dot-mid"></span>Likely</span>
        <span><span class="legend-dot dot-low"></span>Possible</span>

        <select id="mapStyleSelect" class="control map-style" title="Map style">
          <option value="osm">OSM Standard</option>
          <option value="cartoLight">Carto Light</option>
          <option value="cartoDark">Carto Dark</option>
          <option value="esri">Esri Streets</option>
        </select>
      </div>

      <div id="map"></div>
    </main>
  </div>

  <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js" crossorigin=""></script>

  <script>
    const CATS = [
      { k: "cafe",    l: "Caf√©s",            m: t => ["cafe","restaurant","fast_food","food_court"].includes(t.amenity) },
      { k: "library", l: "Libraries",        m: t => t.amenity === "library" },
      { k: "campus",  l: "Campus",           m: t => ["college","university","school"].includes(t.amenity) },
      { k: "cowork",  l: "Coworking",        m: t => ["coworking","co-working"].includes(t.office) },
      { k: "transit", l: "Transit",          m: t => !!t.public_transport || t.railway === "station" || t.amenity === "bus_station" },
      { k: "mall",    l: "Malls",            m: t => t.shop === "mall" || t.building === "retail" },
      { k: "hotel",   l: "Hotels",           m: t => ["hotel","hostel"].includes(t.tourism) },
      { k: "explicit",l: "Explicit outlets", m: t => "socket" in t || "socket:usb" in t || "charging" in t || "power_supply" in t || "outlet" in t }
    ];

    const LS = {
      fav: "csp_ultimate_favs",
      votes: "csp_ultimate_votes",
      cache: "csp_ultimate_cache",
      settings: "csp_ultimate_settings"
    };

    const MAP_STYLES = {
      osm: {
        url: "https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png",
        options: { attribution: "&copy; OpenStreetMap contributors", maxZoom: 19 }
      },
      cartoLight: {
        url: "https://a.basemaps.cartocdn.com/light_all/{z}/{x}/{y}.png",
        options: { attribution: "&copy; OpenStreetMap contributors &copy; CARTO", maxZoom: 20 }
      },
      cartoDark: {
        url: "https://a.basemaps.cartocdn.com/dark_all/{z}/{x}/{y}.png",
        options: { attribution: "&copy; OpenStreetMap contributors &copy; CARTO", maxZoom: 20 }
      },
      esri: {
        url: "https://server.arcgisonline.com/ArcGIS/rest/services/World_Street_Map/MapServer/tile/{z}/{y}/{x}",
        options: { attribution: "Tiles &copy; Esri", maxZoom: 19 }
      }
    };

    let curLat = null, curLon = null;
    let all = [], shown = [];
    let selected = new Set(CATS.map(c => c.k));

    // Autocomplete state
    let suggestTimer = null;
    let activeSuggestIndex = -1;
    let currentSuggestions = [];
    let selectedSuggestion = null; // {lat,lon,label}

    const $ = id => document.getElementById(id);

    const esc = s => String(s ?? "")
      .replaceAll("&","&amp;")
      .replaceAll("<","&lt;")
      .replaceAll(">","&gt;")
      .replaceAll('"',"&quot;")
      .replaceAll("'","&#39;");

    const fmt = new Intl.NumberFormat(undefined, { maximumFractionDigits: 2 });

    function pj(key, fallback) {
      try { return JSON.parse(localStorage.getItem(key) || JSON.stringify(fallback)); }
      catch { return fallback; }
    }

    function sj(key, value) {
      localStorage.setItem(key, JSON.stringify(value));
    }

    function hav(a,b,c,d) {
      const R = 6371, t = x => x * Math.PI / 180;
      const dl = t(c - a), dn = t(d - b);
      const q = Math.sin(dl/2)**2 + Math.cos(t(a))*Math.cos(t(c))*Math.sin(dn/2)**2;
      return 2 * R * Math.asin(Math.sqrt(q));
    }

    function ll(el) {
      if (el.lat != null && el.lon != null) return [el.lat, el.lon];
      if (el.center?.lat != null && el.center?.lon != null) return [el.center.lat, el.center.lon];
      return [null, null];
    }

    function dir(fl, fo, tl, to, m = "walking") {
      return `https://www.google.com/maps/dir/?api=1&origin=${fl},${fo}&destination=${tl},${to}&travelmode=${m}`;
    }

    function is247(t) {
      return (t.opening_hours || "").trim() === "24/7"
        || t.railway === "station"
        || t.amenity === "bus_station";
    }

    function hasWifi(t) {
      return t.wifi === "yes" || t.internet_access === "yes" || t.internet_access === "wlan";
    }

    function status(msg, isError = false) {
      $("status").innerHTML = isError
        ? `<span style="color:#fecaca">${esc(msg)}</span>`
        : esc(msg);
    }

    function saveSettings() {
      sj(LS.settings, {
        radiusKm: Number($("radiusKm").value || 5),
        sortBy: $("sortBy").value,
        open247Only: $("open247Only").checked,
        showHeat: $("showHeat").checked,
        wifiOnly: $("wifiOnly").checked,
        highConfidenceOnly: $("highConfidenceOnly").checked,
        selectedCats: [...selected],
        theme: document.body.classList.contains("theme-light") ? "light" : "dark",
        sidebarCollapsed: $("app").classList.contains("sidebar-collapsed"),
        mapStyle: $("mapStyleSelect").value || "osm",
        mapCenter: (curLat != null && curLon != null) ? [curLat, curLon] : null
      });
    }

    function loadSettings() {
      const s = pj(LS.settings, null);
      if (!s) return;

      if (Number.isFinite(s.radiusKm)) $("radiusKm").value = s.radiusKm;
      if (s.sortBy) $("sortBy").value = s.sortBy;
      $("open247Only").checked = !!s.open247Only;
      $("showHeat").checked = s.showHeat !== false;
      $("wifiOnly").checked = !!s.wifiOnly;
      $("highConfidenceOnly").checked = !!s.highConfidenceOnly;

      if (Array.isArray(s.selectedCats) && s.selectedCats.length) {
        selected = new Set(s.selectedCats.filter(k => CATS.some(c => c.k === k)));
      }

      if (s.theme === "light") document.body.classList.add("theme-light");
      if (s.sidebarCollapsed) $("app").classList.add("sidebar-collapsed");
      if (s.mapStyle && MAP_STYLES[s.mapStyle]) $("mapStyleSelect").value = s.mapStyle;

      if (Array.isArray(s.mapCenter) && s.mapCenter.length === 2) {
        curLat = Number(s.mapCenter[0]);
        curLon = Number(s.mapCenter[1]);
      }
    }

    function votes() { return pj(LS.votes, {}); }
    function getVote(id) { return votes()[id] || { yes: 0, no: 0 }; }

    function castVote(id, type) {
      const v = votes();
      const row = v[id] || { yes: 0, no: 0 };
      if (type === "yes") row.yes += 1;
      if (type === "no") row.no += 1;
      v[id] = row;
      sj(LS.votes, v);
    }

    function cScore(id) {
      const v = getVote(id);
      const t = v.yes + v.no;
      if (!t) return 0;
      return (v.yes - v.no) / t;
    }

    function scoreOSM(t) {
      let s = 0;
      ["socket","socket:usb","charging","power_supply","outlet"].forEach(k => { if (k in t) s += 4; });
      if (["cafe","restaurant","fast_food","food_court"].includes(t.amenity)) s += 3;
      if (["library","college","university","school"].includes(t.amenity)) s += 3;
      if (["coworking","co-working"].includes(t.office)) s += 3;
      if (t.shop === "mall" || t.building === "retail") s += 2;
      if (["hotel","hostel"].includes(t.tourism)) s += 2;
      if (t.public_transport || t.railway === "station" || t.amenity === "bus_station") s += 2;
      if (hasWifi(t)) s += 1;
      if (is247(t)) s += 1;
      return s;
    }

    function confLevel(p) {
      const adj = p.base + cScore(p.id) * 2;
      if (adj >= 8) return "high";
      if (adj >= 5) return "mid";
      return "low";
    }

    function confLabel(p) {
      const lvl = confLevel(p);
      if (lvl === "high") return "High confidence";
      if (lvl === "mid") return "Likely";
      return "Possible";
    }

    function weightedRank(p) {
      return p.base + cScore(p.id) * 2 - p.dist * 0.25 + (p.is247 ? 0.6 : 0) + (p.hasWifi ? 0.3 : 0);
    }

    const map = L.map("map", { zoomControl: true }).setView([43.6532, -79.3832], 12);

    const guaranteedOSM = L.tileLayer(MAP_STYLES.osm.url, MAP_STYLES.osm.options).addTo(map);
    let currentBaseLayer = guaranteedOSM;

    function setMapStyle(styleKey) {
      if (!MAP_STYLES[styleKey]) styleKey = "osm";
      const cfg = MAP_STYLES[styleKey];

      if (styleKey === "osm") {
        if (!map.hasLayer(guaranteedOSM)) guaranteedOSM.addTo(map);
        if (currentBaseLayer && currentBaseLayer !== guaranteedOSM && map.hasLayer(currentBaseLayer)) {
          map.removeLayer(currentBaseLayer);
        }
        currentBaseLayer = guaranteedOSM;
        saveSettings();
        return;
      }

      const candidate = L.tileLayer(cfg.url, cfg.options);
      let swapped = false;

      const finalizeSwap = () => {
        if (swapped) return;
        swapped = true;
        if (currentBaseLayer && map.hasLayer(currentBaseLayer)) map.removeLayer(currentBaseLayer);
        currentBaseLayer = candidate;
        saveSettings();
      };

      candidate.once("load", finalizeSwap);

      candidate.once("tileerror", () => {
        if (!map.hasLayer(guaranteedOSM)) guaranteedOSM.addTo(map);
        if (map.hasLayer(candidate)) map.removeLayer(candidate);
        if (currentBaseLayer && currentBaseLayer !== guaranteedOSM && map.hasLayer(currentBaseLayer)) {
          map.removeLayer(currentBaseLayer);
        }
        currentBaseLayer = guaranteedOSM;
        $("mapStyleSelect").value = "osm";
        saveSettings();
      });

      candidate.addTo(map);
      setTimeout(() => {
        if (!swapped && map.hasLayer(candidate)) finalizeSwap();
      }, 1400);
    }

    let placeLayer = L.layerGroup().addTo(map);
    let heatLayer = L.layerGroup().addTo(map);
    let me = null, circle = null;

    function markerStyle(p) {
      const level = confLevel(p);
      if (level === "high") return { radius: 8, color: "#22c55e", fillColor: "#22c55e", fillOpacity: 0.32, weight: 1.4 };
      if (level === "mid") return { radius: 7, color: "#f59e0b", fillColor: "#f59e0b", fillOpacity: 0.3, weight: 1.3 };
      return { radius: 6, color: "#ef4444", fillColor: "#ef4444", fillOpacity: 0.28, weight: 1.2 };
    }

    function favs() { return pj(LS.fav, []); }
    function isFav(id) { return favs().some(f => f.id === id); }

    function toggleFav(p) {
      const fs = favs();
      const i = fs.findIndex(x => x.id === p.id);
      if (i >= 0) fs.splice(i, 1);
      else fs.push({ id: p.id, name: p.name, type: p.type, lat: p.lat, lon: p.lon, dist: p.dist, savedAt: Date.now() });
      sj(LS.fav, fs);
      renderFav();
      renderResults();
    }

    function exportFavs() {
      const blob = new Blob([JSON.stringify({ exportedAt: Date.now(), favorites: favs() }, null, 2)], { type: "application/json" });
      const a = document.createElement("a");
      a.href = URL.createObjectURL(blob);
      a.download = "public-charging-favorites.json";
      a.click();
      URL.revokeObjectURL(a.href);
    }

    function importFavsFromFile(file) {
      const r = new FileReader();
      r.onload = () => {
        try {
          const data = JSON.parse(String(r.result || "{}"));
          const imported = Array.isArray(data.favorites) ? data.favorites : [];
          if (!imported.length) throw new Error("No favorites found in file.");
          sj(LS.fav, imported);
          renderFav();
          renderResults();
          status(`Imported ${imported.length} favorite(s).`);
        } catch (e) {
          status(`Import failed: ${e.message || "Invalid JSON file."}`, true);
        }
      };
      r.readAsText(file);
    }

    function renderFav() {
      const box = $("favList");
      const fs = favs();
      box.innerHTML = "";

      if (!fs.length) {
        box.innerHTML = `<div class="card"><div class="meta">No favorites yet.</div></div>`;
        return;
      }

      fs.sort((a,b) => (b.savedAt || 0) - (a.savedAt || 0));

      fs.forEach(f => {
        const c = document.createElement("div");
        c.className = "card";
        c.innerHTML = `
          <div class="title-row">
            <div class="title">${esc(f.name)}</div>
            <span class="confidence conf-mid">Saved</span>
          </div>
          <div class="meta">${esc(f.type)} ${f.dist != null ? "‚Ä¢ " + fmt.format(f.dist) + " km" : ""}</div>
          <div class="actions">
            <a class="pill" target="_blank" rel="noopener" href="${dir(curLat ?? f.lat, curLon ?? f.lon, f.lat, f.lon, "walking")}">Walk</a>
            <a class="pill" target="_blank" rel="noopener" href="${dir(curLat ?? f.lat, curLon ?? f.lon, f.lat, f.lon, "driving")}">Drive</a>
            <a class="pill" target="_blank" rel="noopener" href="${dir(curLat ?? f.lat, curLon ?? f.lon, f.lat, f.lon, "transit")}">Transit</a>
          </div>
        `;
        c.onclick = () => map.setView([f.lat, f.lon], 17);
        box.appendChild(c);
      });
    }

    async function geocodeAddress(address) {
      const q = String(address || "").trim();
      if (!q) throw new Error("Please enter an address.");

      const url = "https://nominatim.openstreetmap.org/search?" + new URLSearchParams({
        q, format: "jsonv2", limit: "1", addressdetails: "1"
      }).toString();

      const res = await fetch(url, { headers: { "Accept": "application/json" } });
      if (!res.ok) throw new Error(`Geocoding failed (${res.status})`);

      const data = await res.json();
      if (!Array.isArray(data) || !data.length) throw new Error("Address not found. Try a more specific address.");

      const lat = Number(data[0].lat), lon = Number(data[0].lon);
      if (!Number.isFinite(lat) || !Number.isFinite(lon)) throw new Error("Invalid coordinates returned.");
      return { lat, lon, label: data[0].display_name || q };
    }

    // ===== Autocomplete functions =====
    function splitLabel(label) {
      const parts = String(label || "").split(",").map(s => s.trim()).filter(Boolean);
      return {
        main: parts.slice(0, 2).join(", ") || label || "",
        sub: parts.slice(2).join(", ")
      };
    }

    function hideSuggestions() {
      const box = $("suggestions");
      box.style.display = "none";
      box.innerHTML = "";
      currentSuggestions = [];
      activeSuggestIndex = -1;
    }

    function showSuggestions(items) {
      const box = $("suggestions");
      currentSuggestions = items;
      activeSuggestIndex = -1;
      box.innerHTML = "";

      if (!items.length) {
        hideSuggestions();
        return;
      }

      items.forEach((item, idx) => {
        const { main, sub } = splitLabel(item.display_name);
        const row = document.createElement("div");
        row.className = "suggestion-item";
        row.setAttribute("role", "option");
        row.dataset.index = String(idx);
        row.innerHTML = `
          <div class="suggestion-main">${esc(main)}</div>
          <div class="suggestion-sub">${esc(sub)}</div>
        `;
        row.addEventListener("mousedown", (e) => {
          // mousedown so it fires before input blur
          e.preventDefault();
          pickSuggestion(idx);
        });
        box.appendChild(row);
      });

      box.style.display = "block";
    }

    function setActiveSuggestion(index) {
      const box = $("suggestions");
      const nodes = box.querySelectorAll(".suggestion-item");
      nodes.forEach(n => n.classList.remove("active"));
      if (index >= 0 && index < nodes.length) {
        nodes[index].classList.add("active");
        nodes[index].scrollIntoView({ block: "nearest" });
      }
    }

    function pickSuggestion(index) {
      const item = currentSuggestions[index];
      if (!item) return;
      $("addressInput").value = item.display_name;
      selectedSuggestion = {
        lat: Number(item.lat),
        lon: Number(item.lon),
        label: item.display_name
      };
      hideSuggestions();
    }

    async function fetchAddressSuggestions(query) {
      const q = String(query || "").trim();
      if (q.length < 3) return [];

      const params = new URLSearchParams({
        q,
        format: "jsonv2",
        addressdetails: "1",
        limit: "6"
      });

      const res = await fetch("https://nominatim.openstreetmap.org/search?" + params.toString(), {
        headers: { "Accept": "application/json" }
      });
      if (!res.ok) return [];
      const data = await res.json();
      if (!Array.isArray(data)) return [];
      return data;
    }

    async function fetchOSM(lat, lon, km) {
      const r = Math.round(km * 1000);
      const q = `
[out:json][timeout:45];
(
  nwr(around:${r},${lat},${lon})[amenity~"cafe|restaurant|fast_food|food_court|library|college|university|school|bus_station|atm"];
  nwr(around:${r},${lat},${lon})[shop="mall"];
  nwr(around:${r},${lat},${lon})[tourism~"hotel|hostel"];
  nwr(around:${r},${lat},${lon})[public_transport];
  nwr(around:${r},${lat},${lon})[railway="station"];
  nwr(around:${r},${lat},${lon})[office~"coworking|co-working"];
  nwr(around:${r},${lat},${lon})["socket"];
  nwr(around:${r},${lat},${lon})["socket:usb"];
  nwr(around:${r},${lat},${lon})["charging"];
  nwr(around:${r},${lat},${lon})["power_supply"];
  nwr(around:${r},${lat},${lon})["outlet"];
);
out center tags;`.trim();

      const res = await fetch("https://overpass-api.de/api/interpreter", {
        method: "POST",
        headers: { "Content-Type": "application/x-www-form-urlencoded; charset=UTF-8" },
        body: new URLSearchParams({ data: q })
      });

      if (!res.ok) throw new Error(`Overpass failed (${res.status})`);
      const data = await res.json();
      return data.elements || [];
    }

    function normalize(elements, lat, lon) {
      const m = new Map();
      for (const e of elements) {
        const [la, lo] = ll(e);
        if (la == null || lo == null) continue;

        const t = e.tags || {};
        const id = `${e.type}/${e.id}`;
        const base = scoreOSM(t);
        if (base < 2) continue;

        m.set(id, {
          id, lat: la, lon: lo, tags: t,
          name: t.name || t.brand || "Unnamed place",
          type: t.amenity || t.shop || t.tourism || t.office || t.public_transport || t.railway || "place",
          base,
          dist: hav(lat, lon, la, lo),
          is247: is247(t),
          hasWifi: hasWifi(t),
          tagsPreview: Object.entries(t)
            .filter(([k]) => [
              "amenity","shop","tourism","office","public_transport","railway",
              "socket","socket:usb","charging","power_supply","outlet","opening_hours","wifi","internet_access"
            ].includes(k))
            .slice(0, 8)
            .map(([k,v]) => `${k}:${v}`)
        });
      }
      return [...m.values()];
    }

    function apply() {
      const sort = $("sortBy").value;
      const only247 = $("open247Only").checked;
      const wifiOnly = $("wifiOnly").checked;
      const highOnly = $("highConfidenceOnly").checked;

      shown = all.filter(p => {
        const cat = CATS.some(c => selected.has(c.k) && c.m(p.tags));
        return cat
          && (!only247 || p.is247)
          && (!wifiOnly || p.hasWifi)
          && (!highOnly || confLevel(p) === "high");
      });

      shown.sort((a, b) => {
        if (sort === "nearest") return a.dist - b.dist;
        if (sort === "community") return cScore(b.id) - cScore(a.id) || a.dist - b.dist;
        if (sort === "confidence") {
          const lv = { high: 3, mid: 2, low: 1 };
          return lv[confLevel(b)] - lv[confLevel(a)] || weightedRank(b) - weightedRank(a);
        }
        return weightedRank(b) - weightedRank(a);
      });
    }

    function updateKpis() {
      $("kpiTotal").textContent = String(shown.length);
      $("kpiHigh").textContent = String(shown.filter(p => confLevel(p) === "high").length);
      const avg = shown.length ? shown.reduce((s,p) => s + p.dist, 0) / shown.length : 0;
      $("kpiAvgDist").textContent = `${fmt.format(avg)} km`;
    }

    function renderHeat() {
      heatLayer.clearLayers();
      if (!$("showHeat").checked) return;

      shown.slice(0, 140).forEach(p => {
        const intensity = Math.max(0, Math.min(1, (p.base / 12) + (cScore(p.id) * 0.25)));
        L.circle([p.lat, p.lon], {
          radius: 70 + intensity * 150,
          weight: 0,
          fillOpacity: 0.08 + intensity * 0.2,
          fillColor: confLevel(p) === "high" ? "#22c55e" : confLevel(p) === "mid" ? "#f59e0b" : "#ef4444"
        }).addTo(heatLayer);
      });
    }

    function renderMap() {
      placeLayer.clearLayers();

      if (me) map.removeLayer(me);
      if (circle) map.removeLayer(circle);

      const km = Number($("radiusKm").value || 5);

      if (curLat != null && curLon != null) {
        me = L.marker([curLat, curLon]).addTo(map).bindPopup("<b>Your selected location</b>");
        circle = L.circle([curLat, curLon], {
          radius: km * 1000,
          fillOpacity: 0.05,
          color: "#4f46e5",
          weight: 1.2
        }).addTo(map);
      }

      shown.slice(0, 260).forEach(p => {
        const v = getVote(p.id);
        L.circleMarker([p.lat, p.lon], markerStyle(p))
          .addTo(placeLayer)
          .bindPopup(`
            <div style="min-width:240px">
              <div style="font-weight:900; margin-bottom:2px">${esc(p.name)}</div>
              <div style="font-size:12px; color:#8ea3bf">${esc(p.type)} ‚Ä¢ ${fmt.format(p.dist)} km</div>
              <div style="font-size:12px; color:#8ea3bf; margin-top:2px">${confLabel(p)}${p.is247 ? " ‚Ä¢ 24/7 likely" : ""}${p.hasWifi ? " ‚Ä¢ Wi-Fi likely" : ""}</div>
              <div style="font-size:12px; color:#8ea3bf; margin-top:2px">Community: üëç ${v.yes} ‚Ä¢ üëé ${v.no}</div>
            </div>
          `);
      });

      renderHeat();

      if (curLat != null && curLon != null) {
        const layers = [me, circle, ...placeLayer.getLayers()].filter(Boolean);
        if (layers.length) {
          const fg = L.featureGroup(layers);
          const b = fg.getBounds();
          if (b.isValid()) map.fitBounds(b.pad(0.2), { maxZoom: 15 });
        }
      }
    }

    function confidenceBadge(p) {
      const lvl = confLevel(p);
      if (lvl === "high") return `<span class="confidence conf-high">High</span>`;
      if (lvl === "mid") return `<span class="confidence conf-mid">Likely</span>`;
      return `<span class="confidence conf-low">Possible</span>`;
    }

    function cardHTML(p) {
      const v = getVote(p.id);
      return `
        <div class="title-row">
          <div class="title">${esc(p.name)}</div>
          ${confidenceBadge(p)}
        </div>
        <div class="meta">
          ${esc(p.type)} ‚Ä¢ ${fmt.format(p.dist)} km
          ${p.is247 ? " ‚Ä¢ 24/7 likely" : ""}
          ${p.hasWifi ? " ‚Ä¢ Wi-Fi likely" : ""}
        </div>
        <div>${p.tagsPreview.slice(0,6).map(t => `<span class="pill">${esc(t)}</span>`).join("")}</div>
        <div class="meta">Community: üëç ${v.yes} ‚Ä¢ üëé ${v.no}</div>
        <div class="actions">
          <a class="pill" target="_blank" rel="noopener" href="${dir(curLat, curLon, p.lat, p.lon, "walking")}">Walk</a>
          <a class="pill" target="_blank" rel="noopener" href="${dir(curLat, curLon, p.lat, p.lon, "driving")}">Drive</a>
          <a class="pill" target="_blank" rel="noopener" href="${dir(curLat, curLon, p.lat, p.lon, "transit")}">Transit</a>
          <button class="pill-btn fav" data-id="${esc(p.id)}">${isFav(p.id) ? "‚òÖ Saved" : "‚òÜ Save"}</button>
          <button class="pill-btn ok yes" data-id="${esc(p.id)}">I charged here</button>
          <button class="pill-btn bad no" data-id="${esc(p.id)}">No outlet</button>
        </div>
      `;
    }

    function renderResults() {
      const box = $("results");
      box.innerHTML = "";
      $("count").textContent = `${shown.length} match(es)`;
      updateKpis();

      if (!shown.length) {
        box.innerHTML = `<div class="card"><div class="meta">No matches. Try a larger radius or fewer filters.</div></div>`;
        return;
      }

      shown.slice(0, 120).forEach(p => {
        const c = document.createElement("div");
        c.className = "card";
        c.innerHTML = cardHTML(p);

        c.onclick = (e) => {
          if (e.target.closest("button") || e.target.closest("a")) return;
          map.setView([p.lat, p.lon], 17);
        };

        box.appendChild(c);
      });

      box.querySelectorAll(".fav").forEach(btn => {
        btn.onclick = (e) => {
          e.stopPropagation();
          const p = shown.find(x => x.id === btn.dataset.id);
          if (p) toggleFav(p);
        };
      });

      box.querySelectorAll(".yes").forEach(btn => {
        btn.onclick = (e) => {
          e.stopPropagation();
          castVote(btn.dataset.id, "yes");
          apply(); renderResults(); renderMap();
        };
      });

      box.querySelectorAll(".no").forEach(btn => {
        btn.onclick = (e) => {
          e.stopPropagation();
          castVote(btn.dataset.id, "no");
          apply(); renderResults(); renderMap();
        };
      });
    }

    function renderChips() {
      const box = $("chips");
      box.innerHTML = "";
      CATS.forEach(c => {
        const d = document.createElement("div");
        d.className = "chip" + (selected.has(c.k) ? " active" : "");
        d.textContent = c.l;
        d.onclick = () => {
          if (selected.has(c.k)) selected.delete(c.k);
          else selected.add(c.k);
          d.classList.toggle("active");
          saveSettings();
          apply(); renderResults(); renderMap();
        };
        box.appendChild(d);
      });
    }

    function saveCache() {
      sj(LS.cache, {
        savedAt: Date.now(),
        lat: curLat, lon: curLon,
        radiusKm: Number($("radiusKm").value || 5),
        items: all.slice(0, 400)
      });
    }

    function loadCache() {
      const c = pj(LS.cache, null);
      if (!c || !c.items) {
        status("No offline cache found yet.", true);
        return;
      }
      curLat = c.lat;
      curLon = c.lon;
      $("radiusKm").value = c.radiusKm;
      all = c.items;

      apply(); renderResults(); renderMap();
      saveSettings();
      status(`Loaded offline cache from ${new Date(c.savedAt).toLocaleString()}.`);
    }

    async function search() {
      if (curLat == null || curLon == null) {
        status("Enable location or enter an address first.", true);
        return;
      }

      const km = Number($("radiusKm").value || 5);
      if (!Number.isFinite(km) || km < 1 || km > 30) {
        status("Radius must be between 1 and 30 km.", true);
        return;
      }

      $("locateBtn").disabled = true;
      $("refreshBtn").disabled = true;
      $("useAddressBtn").disabled = true;
      status("Searching nearby places...");

      try {
        const raw = await fetchOSM(curLat, curLon, km);
        all = normalize(raw, curLat, curLon);
        saveCache();
        saveSettings();

        apply();
        renderResults();
        renderMap();

        status(`Found ${shown.length} matches within ${km} km.`);
      } catch (e) {
        console.error(e);
        status(`Search failed: ${e?.message || "Unknown error"}. Try again or load cache.`, true);
      } finally {
        $("locateBtn").disabled = false;
        $("refreshBtn").disabled = false;
        $("useAddressBtn").disabled = false;
      }
    }

    function locate() {
      if (!navigator.geolocation) {
        status("Geolocation is not supported by this browser.", true);
        return;
      }
      status("Getting your location...");
      navigator.geolocation.getCurrentPosition(
        (pos) => {
          curLat = pos.coords.latitude;
          curLon = pos.coords.longitude;
          map.setView([curLat, curLon], 14);
          search();
        },
        (err) => {
          console.error(err);
          status("Location denied or unavailable. Enter an address instead.", true);
        },
        { enableHighAccuracy: true, timeout: 15000, maximumAge: 30000 }
      );
    }

    async function useAddress() {
      const addr = $("addressInput").value.trim();
      if (!addr) {
        status("Please enter an address.", true);
        return;
      }

      $("useAddressBtn").disabled = true;
      $("locateBtn").disabled = true;
      $("refreshBtn").disabled = true;
      status("Looking up address...");

      try {
        let picked = selectedSuggestion;

        // If user typed after selecting a suggestion, invalidate selectedSuggestion
        if (picked && picked.label !== addr) picked = null;

        if (!picked) {
          picked = await geocodeAddress(addr);
        }

        curLat = Number(picked.lat);
        curLon = Number(picked.lon);

        map.setView([curLat, curLon], 14);
        status(`Using address: ${picked.label || addr}`);
        hideSuggestions();
        await search();
      } catch (e) {
        console.error(e);
        status(e.message || "Could not use that address.", true);
      } finally {
        $("useAddressBtn").disabled = false;
        $("locateBtn").disabled = false;
        $("refreshBtn").disabled = false;
      }
    }

    function toggleTheme() {
      document.body.classList.toggle("theme-light");
      saveSettings();
    }

    function toggleSidebar() {
      $("app").classList.toggle("sidebar-collapsed");
      setTimeout(() => map.invalidateSize(), 220);
      saveSettings();
    }

    function registerAutocomplete() {
      const input = $("addressInput");
      const box = $("suggestions");

      input.addEventListener("input", () => {
        const q = input.value.trim();
        selectedSuggestion = null; // user changed text
        activeSuggestIndex = -1;

        if (suggestTimer) clearTimeout(suggestTimer);

        if (q.length < 3) {
          hideSuggestions();
          return;
        }

        suggestTimer = setTimeout(async () => {
          try {
            const results = await fetchAddressSuggestions(q);
            // if input changed while waiting, ignore stale result
            if (input.value.trim() !== q) return;
            showSuggestions(results);
          } catch (e) {
            console.error(e);
            hideSuggestions();
          }
        }, 260);
      });

      input.addEventListener("keydown", (e) => {
        const visible = box.style.display === "block" && currentSuggestions.length > 0;

        if (e.key === "ArrowDown" && visible) {
          e.preventDefault();
          activeSuggestIndex = (activeSuggestIndex + 1) % currentSuggestions.length;
          setActiveSuggestion(activeSuggestIndex);
          return;
        }

        if (e.key === "ArrowUp" && visible) {
          e.preventDefault();
          activeSuggestIndex = (activeSuggestIndex - 1 + currentSuggestions.length) % currentSuggestions.length;
          setActiveSuggestion(activeSuggestIndex);
          return;
        }

        if (e.key === "Enter") {
          e.preventDefault();
          if (visible && activeSuggestIndex >= 0) {
            pickSuggestion(activeSuggestIndex);
          }
          useAddress();
          return;
        }

        if (e.key === "Escape") {
          hideSuggestions();
        }
      });

      input.addEventListener("focus", () => {
        if (currentSuggestions.length) $("suggestions").style.display = "block";
      });

      // Delay hide so click/mousedown can register
      input.addEventListener("blur", () => {
        setTimeout(() => hideSuggestions(), 120);
      });

      document.addEventListener("click", (e) => {
        const wrap = e.target.closest(".autocomplete-wrap");
        if (!wrap) hideSuggestions();
      });
    }

    function registerEvents() {
      $("locateBtn").onclick = locate;
      $("refreshBtn").onclick = search;
      $("offlineBtn").onclick = loadCache;
      $("useAddressBtn").onclick = useAddress;

      $("sortBy").onchange = () => { saveSettings(); apply(); renderResults(); renderMap(); };
      $("open247Only").onchange = () => { saveSettings(); apply(); renderResults(); renderMap(); };
      $("showHeat").onchange = () => { saveSettings(); renderMap(); };
      $("wifiOnly").onchange = () => { saveSettings(); apply(); renderResults(); renderMap(); };
      $("highConfidenceOnly").onchange = () => { saveSettings(); apply(); renderResults(); renderMap(); };
      $("radiusKm").onchange = saveSettings;

      $("clearFavBtn").onclick = () => {
        localStorage.removeItem(LS.fav);
        renderFav(); renderResults();
        status("Favorites cleared.");
      };

      $("exportFavBtn").onclick = exportFavs;
      $("importFavBtn").onclick = () => $("importFavFile").click();
      $("importFavFile").addEventListener("change", (e) => {
        const file = e.target.files?.[0];
        if (file) importFavsFromFile(file);
        e.target.value = "";
      });

      $("selectAllCatsBtn").onclick = () => {
        selected = new Set(CATS.map(c => c.k));
        renderChips(); saveSettings();
        apply(); renderResults(); renderMap();
      };

      $("clearCatsBtn").onclick = () => {
        selected = new Set();
        renderChips(); saveSettings();
        apply(); renderResults(); renderMap();
      };

      $("themeBtn").onclick = toggleTheme;
      $("collapseBtn").onclick = toggleSidebar;
      $("mapStyleSelect").onchange = () => setMapStyle($("mapStyleSelect").value);

      window.addEventListener("resize", () => map.invalidateSize());

      registerAutocomplete();
    }

    (function init() {
      try {
        loadSettings();
        setMapStyle($("mapStyleSelect").value || "osm");
        registerEvents();
        renderChips();
        renderFav();

        if (curLat != null && curLon != null) map.setView([curLat, curLon], 13);

        apply();
        renderResults();
        renderMap();
      } catch (e) {
        console.error(e);
        status(`Initialization error: ${e?.message || "Unknown error"}`, true);
      }
    })();
  </script>
</body>
</html>
